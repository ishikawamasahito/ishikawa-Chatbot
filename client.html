<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿæ”¯æ´ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; overflow-x: hidden; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(255, 255, 255, 0.98); border-radius: 25px; box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15); overflow: hidden; display: flex; flex-direction: column; height: calc(100vh - 40px); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3); }
        .chat-container { display: flex; flex-direction: column; flex-grow: 1; background: white; overflow: hidden; position: relative; }
        .chat-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; text-align: center; font-weight: 600; font-size: 1.1rem; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 15px 20px; border-radius: 20px; position: relative; animation: slideIn 0.3s ease-out; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; align-self: flex-end; margin-left: auto; }
        .message.bot { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); color: #333; align-self: flex-start; border-left: 4px solid #4facfe; }
        .message-content { line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        .message-time { font-size: 0.8rem; opacity: 0.7; margin-top: 8px; }
        .chat-input-container { padding: 20px; background: #f8f9fa; border-top: 1px solid #e9ecef; }
        .chat-input-box { display: flex; gap: 10px; align-items: flex-end; }
        .chat-input { flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px; outline: none; transition: all 0.3s ease; resize: none; min-height: 50px; max-height: 120px; }
        .chat-input:focus { border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .send-btn { padding: 15px 25px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .send-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3); }
        .send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .feedback-container { margin-top: 12px; padding-top: 8px; border-top: 1px solid #ddd; }
        .feedback-btn { background: none; border: 1px solid #ccc; border-radius: 15px; padding: 3px 8px; margin-left: 8px; cursor: pointer; transition: all 0.2s ease; }
        .feedback-btn:hover { background: #e9ecef; transform: scale(1.1); }
        .error-message { background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #f44336; }
        .loading-indicator { display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #4facfe; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 480px) {
            body { padding: 5px; }
            .container { height: calc(100vh - 10px); }
            .header { padding: 20px; }
            .header h1 { font-size: 1.6rem; }
            .chat-input-container { padding: 15px; }
            .chat-input-box { flex-direction: column; align-items: stretch; }
            .send-btn { justify-content: center; padding: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” å­¦ç”Ÿæ”¯æ´ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</h1>
            <p>å­¦ç”Ÿç”Ÿæ´»ã«é–¢ã™ã‚‹æ§˜ã€…ãªè³ªå•ã«ãŠç­”ãˆã—ã¾ã™ï¼</p>
        </div>
        <div class="chat-container">
            <div class="chat-header">ğŸ’¬ AIãƒãƒ£ãƒƒãƒˆ</div>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-content">
                        ç§ã¯å­¦ç”Ÿæ”¯æ´ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚ğŸš€<br>
                        - å­¦ç”Ÿè¨¼ã‚’ç´›å¤±ãƒ»ç›—é›£ãƒ»æ±šæã—ãŸã¨ãã¯ï¼Ÿ<br>
                        - æ–°ã—ã„ã‚µãƒ¼ã‚¯ãƒ«ã‚’ä½œã‚‹ã«ã¯ï¼Ÿ<br>
                        - ä¼‘å­¦ãƒ»å¾©å­¦ãƒ»é€€å­¦ã®æ‰‹ç¶šãã‚’ã—ãŸã„ã¨ãã¯ï¼Ÿ<br>
                        æ§˜ã€…ãªè³ªå•ã«ãŠç­”ãˆã—ã¾ã™ï¼
                    </div>
                    <div class="message-time">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ™‚åˆ»</div>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-input-box">
                    <textarea id="chatInput" class="chat-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." rows="1"></textarea>
                    <button id="sendBtn" class="send-btn">
                        <span>é€ä¿¡</span>
                        <span>ğŸ”</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // ã‚µãƒ¼ãƒãƒ¼ã®URLã‚’å‹•çš„ã«è¨­å®š
    const BACKEND_API_BASE_URL = window.location.origin;
    
    // DOMè¦ç´ ã®å–å¾—
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    const DEFAULT_CONFIG = {
        model: 'llama3.2:latest',
        collection: 'default',
        embedding_model: 'all-MiniLM-L6-v2',
        top_k: 5
    };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
    function addMessage(text, type) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message ${type}`;
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = text;
        messageWrapper.appendChild(messageContent);
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = new Date().toLocaleTimeString();
        messageWrapper.appendChild(messageTime);

        chatMessages.appendChild(messageWrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageWrapper;
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡é–¢æ•°
    function sendFeedback(element, rating) {
        const messageWrapper = element.closest('.message');
        const logId = messageWrapper.dataset.logId;

        if (!logId) {
            console.error("Log ID not found for feedback.");
            return;
        }
        
        fetch(`${BACKEND_API_BASE_URL}/feedback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                log_id: parseInt(logId, 10),
                rating: rating
            })
        }).then(res => {
            if(!res.ok) {
                console.error("Failed to send feedback.");
            }
        }).catch(error => {
            console.error("Error sending feedback:", error);
        });

        const feedbackContainer = element.parentElement;
        feedbackContainer.innerHTML = '<span style="font-size: 0.8rem; color: #28a745;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</span>';
    }

    // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    async function initializeSystem() {
        try {
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æ¥ç¶šç¢ºèª
            const healthResponse = await fetch(`${BACKEND_API_BASE_URL}/health`);
            if (!healthResponse.ok) {
                addMessage('âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', 'bot');
                return;
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèªãƒ»ä½œæˆ
            try {
                await fetch(`${BACKEND_API_BASE_URL}/collections`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: DEFAULT_CONFIG.collection })
                });
            } catch (error) {
                // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
            }

        } catch (error) {
            addMessage('âŒ ã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'bot');
        }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°
    async function sendMessage() {
        const userInput = chatInput.value.trim();
        if (!userInput) return;

        addMessage(userInput, 'user');
        chatInput.value = '';
        chatInput.style.height = 'auto';
        sendBtn.disabled = true;

        const botMessageElement = addMessage('æ€è€ƒä¸­...', 'bot');
        let fullResponse = '';

        try {
            // è¤‡æ•°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦è¡Œ
            let response;
            const endpoints = ['/chat_for_client', '/chat'];
            let lastError;

            for (const endpoint of endpoints) {
                try {
                    const payload = endpoint === '/chat_for_client' 
                        ? { query: userInput }
                        : {
                            query: userInput,
                            model: DEFAULT_CONFIG.model,
                            collection: DEFAULT_CONFIG.collection,
                            embedding_model: DEFAULT_CONFIG.embedding_model,
                            top_k: DEFAULT_CONFIG.top_k
                        };

                    response = await fetch(`${BACKEND_API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                    }
                    lastError = await response.text();
                } catch (error) {
                    lastError = error.message;
                    continue; // æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦è¡Œ
                }
            }

            if (!response || !response.ok) {
                throw new Error(lastError || 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            botMessageElement.querySelector('.message-content').textContent = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                    if (botMessageElement.dataset.logId) {
                        const feedbackContainer = document.createElement('div');
                        feedbackContainer.className = 'feedback-container';
                        feedbackContainer.innerHTML = `
                        <span>ã“ã®å›ç­”ã¯å½¹ã«ç«‹ã¡ã¾ã—ãŸã‹ï¼Ÿ</span>
                        <button class="feedback-btn" onclick="sendFeedback(this, 'good')">ğŸ‘</button>
                        <button class="feedback-btn" onclick="sendFeedback(this, 'bad')">ğŸ‘</button>
                        `;
                        botMessageElement.appendChild(feedbackContainer);
                    }
                    break;
                }
                
                const chunk = decoder.decode(value, {stream: true});
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.trim().startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            if (data.content) {
                                fullResponse += data.content;
                                botMessageElement.querySelector('.message-content').textContent = fullResponse;
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                            if (data.log_id) {
                                botMessageElement.dataset.logId = data.log_id;
                            }
                        } catch (e) {
                            // JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã«ç™ºç”Ÿã—ã†ã‚‹ã®ã§ç„¡è¦–
                        }
                    }
                }
            }
        } catch (error) {
            console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            
            if (error.message.includes('404') || error.message.includes('Not Found')) {
                errorMessage = 'âŒ ã‚µãƒ¼ãƒãƒ¼ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'âŒ ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            } else {
                errorMessage = `âŒ ${error.message}`;
            }
            
            botMessageElement.querySelector('.message-content').textContent = errorMessage;
        } finally {
            sendBtn.disabled = false;
        }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        sendBtn.addEventListener('click', sendMessage);
        
        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        initializeSystem();
    });
</script>
</body>
</html>